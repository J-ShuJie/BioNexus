# 顶栏模块化与工作流选择器集成（1.3.5）

目标：统一顶部栏为单一模块（ModernToolbar），根据当前页面动态配置按钮与返回目标，避免各页面重复实现本地顶栏。

## 顶栏组件（ModernToolbar）
- 位置与尺寸：固定高 61px，与侧边栏中线对齐。
- 两种模式：
  - 列表模式：显示“下载状态”“筛选”默认按钮，可通过 `set_default_buttons_visible(False)` 隐藏。
  - 详情模式：显示“返回”按钮，支持动态返回目标，通过 `set_back_target(str)` 设置。
- 自定义动作：右侧使用 `set_actions([...])` 注入，支持普通按钮与切换按钮；`clear_actions()` 清空。
- 返回按钮文本：使用 `← + 目标` 形式，超长时自动省略（elide）。

## 页面与顶栏对应关系
- 全部工具（all-tools）
  - 模式：列表
  - 默认按钮：显示（筛选/下载）
  - 自定义动作：无

- 我的工具（my-tools）
  - 模式：列表
  - 默认按钮：显示（筛选/下载）
  - 自定义动作：无

- 设置（settings）
  - 模式：列表
  - 默认按钮：隐藏
  - 自定义动作：无

- 工作流列表（workflows）
  - 模式：列表
  - 默认按钮：隐藏
  - 自定义动作：`新建工作流`
  - 卡片顺序：先展示已有工作流卡片，“新建工作流(＋)”卡片固定放在最后

- 工作流详情（workflow detail）
  - 模式：详情
  - 默认按钮：隐藏
  - 自定义动作：`添加工具`、`编辑排序(切换)`
  - 返回目标：`工作流`

- 工具选择页（ToolPickerPage，内嵌）
  - 模式：详情
  - 默认按钮：隐藏
  - 自定义动作：`完成`
  - 返回目标：当前工作流名称（动态）
  - 返回/完成行为：均回到“工作流详情”。

- 工具详情页（Tool Detail）
  - 模式：详情
  - 返回目标：根据进入来源动态设置：
    - 从“全部工具”进入 → `全部工具`
    - 从“我的工具”进入 → `我的工具`
    - 从“设置”进入 → `设置`
    - 从“工作流”进入 → `工作流`

## 关键实现位置
- 顶栏组件：`ui/modern_toolbar.py`
  - 动态返回文本省略绘制：`_draw_back_button()`（使用 `QFontMetrics.elidedText`）
  - 公共 API：`set_default_buttons_visible`、`set_actions`、`clear_actions`、`set_back_target`

- 主窗口路由：`ui/main_window.py`
  - 工作流详情展示：`_on_open_workflow()`
  - 进入工具选择页：`_on_pick_tool_for_workflow()`（返回目标设为当前工作流名）
  - 选择页完成/返回：`_return_to_workflow_detail()`（恢复“添加工具”“编辑排序”动作）
  - 工具详情页返回目标：`show_tool_detail_page()` 中基于 `_last_non_detail_view` 设置动态返回文本

## i18n
- 采用 YAML i18n（见 `translations/i18n/*.yaml`）。
- 新增键：
  - ModernToolbar: `Back`
  - MainWindow: `Workflows`、`New Workflow`、`Add Tool`、`Edit Order`、`Done`
- 英文环境（en_US）下，支持中文源文案到英文的映射（例如 `新建工作流 → New Workflow`）。

## 注意事项
- 禁止在页面内实现“本地顶栏”；统一使用 `ModernToolbar`。
- 设置自定义动作时，务必同时 `set_default_buttons_visible(False)`，避免重叠。
- 工作流名称过长时，返回按钮文本将自动省略，避免与右侧按钮冲突。
