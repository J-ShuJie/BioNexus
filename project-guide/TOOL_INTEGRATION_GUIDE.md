# 🧬 BioNexus 工具集成开发指南

## ⚠️ 重要提醒
**本指南基于FastQC集成过程中遇到的实际问题总结而成，旨在避免重复相同错误。**
**在集成任何新的生物信息学工具前，请务必完整阅读并按照此检查清单验证。**

---

## 📋 工具集成检查清单

### 🔴 **关键错误预防（必须检查）**

#### ✅ **1. 平台检测问题**
- **问题根源**：开发环境与目标环境不一致（WSL vs Windows）
- **检查点**：
  - [ ] 确认所有平台检测代码强制返回Windows信息
  - [ ] 验证`platform.system()`不影响Windows工具下载
  - [ ] 确保Java/Python环境管理器下载Windows版本
- **代码位置**：`envs/runtime/*.py`, `core/tools/*.py`

#### ✅ **2. 工具文件引用验证**
- **问题根源**：配置文件引用的依赖文件与实际安装文件不匹配
- **检查点**：
  - [ ] 手动验证工具安装后的实际文件结构
  - [ ] 检查所有JAR、DLL、配置文件的引用名称
  - [ ] 确认可执行文件名称（.bat vs .exe vs 脚本）
- **常见错误**：`sam-1.103.jar` vs `htsjdk.jar`

#### ✅ **3. subprocess调用格式**
- **问题根源**：Windows shell调用格式错误
- **检查点**：
  - [ ] `shell=True`时必须传递字符串，不是列表
  - [ ] `shell=False`时必须传递列表，不是字符串
  - [ ] Windows批处理文件(.bat)必须使用`shell=True`
- **正确示例**：
  ```python
  # ✅ 正确
  subprocess.Popen("run_tool.bat", shell=True, cwd=tool_dir)
  
  # ❌ 错误
  subprocess.Popen(["run_tool.bat"], shell=True, cwd=tool_dir)
  ```

#### ✅ **4. 路径可移植性**
- **问题根源**：硬编码绝对路径导致版本更新和用户环境变化时失效
- **检查点**：
  - [ ] 不使用绝对路径（如`C:\Users\...`）
  - [ ] 使用相对路径配合正确的`cwd`参数
  - [ ] 确保路径在不同Windows版本下兼容
- **正确做法**：
  ```python
  # ✅ 可移植
  subprocess.Popen("tool.bat", cwd=self.install_dir)
  
  # ❌ 不可移植
  subprocess.Popen("C:\\BioNexus_1.1.12\\tools\\tool.bat")
  ```

### 🟡 **重要最佳实践**

#### ✅ **5. 环境变量管理**
- **原则**：保守修改，最小影响
- **检查点**：
  - [ ] 只添加必要的PATH条目
  - [ ] 保留所有系统环境变量
  - [ ] 避免设置可能冲突的变量（如JAVA_HOME）
  - [ ] 测试GUI程序正常启动

#### ✅ **6. 工具验证逻辑**
- **原则**：与实际文件结构保持一致
- **检查点**：
  - [ ] 验证函数检查实际存在的文件
  - [ ] 支持工具的多种执行方式
  - [ ] 不依赖运行时网络检查
  - [ ] 提供详细的验证日志

#### ✅ **7. 错误处理和日志**
- **检查点**：
  - [ ] 所有关键步骤都有日志记录
  - [ ] 错误信息提供具体的修复建议
  - [ ] 区分用户错误和系统错误
  - [ ] 提供调试所需的详细信息

---

## 🛠️ **实际集成步骤**

### **步骤1：工具调研**
1. 下载并手动安装工具，了解文件结构
2. 确认可执行文件名称和启动方式
3. 记录所有依赖文件（JAR、DLL、配置文件）
4. 测试在目标Windows环境中的启动方式

### **步骤2：代码实现**
1. 复制现有工具类作为模板（推荐使用FastQC）
2. 按照检查清单逐项验证代码
3. 特别注意平台检测和subprocess调用
4. 使用相对路径和正确的工作目录

### **步骤3：测试验证**
1. 在开发环境测试（注意平台差异）
2. 在真实Windows环境测试
3. 测试不同用户路径和版本更新场景
4. 验证工具启动和GUI显示

### **步骤4：文档更新**
1. 更新工具列表和功能描述
2. 记录任何特殊配置或限制
3. 更新此指南中的经验教训

---

## 🔍 **常见问题诊断**

### **问题：工具启动失败**
1. 检查日志中的subprocess调用格式
2. 验证工作目录和文件路径
3. 确认依赖文件是否存在
4. 测试手动启动是否成功

### **问题：GUI不显示**
1. 检查环境变量是否破坏系统环境
2. 确认没有重定向stdout/stderr
3. 验证Windows GUI环境变量完整性

### **问题：路径错误**
1. 避免绝对路径
2. 检查`cwd`参数设置
3. 确认相对路径结构正确

---

## 📚 **参考案例：FastQC集成**

FastQC的完整修复过程展示了所有这些检查点的重要性：
- 平台检测错误导致下载Linux版本Java
- 文件引用错误导致找不到JAR文件
- subprocess格式错误导致"系统找不到路径"
- 绝对路径导致可移植性问题

通过系统性地应用这个检查清单，FastQC最终实现了完美集成。

---

## ⭐ **开发原则总结**

1. **Windows-First原则**：所有代码默认按Windows环境设计
2. **保守修改原则**：最小化对系统环境的影响
3. **可移植性原则**：避免硬编码路径和环境依赖
4. **实际验证原则**：与真实工具文件结构保持一致
5. **详细日志原则**：提供充分的调试信息

---

**记住：这个检查清单是活文档，随着新工具的集成，请及时更新和完善！**