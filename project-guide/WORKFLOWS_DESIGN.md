# 工作流（分层集合）功能设计 v1.0

本文定义“工作流”功能的产品与技术方案。此处的“工作流”指用户自定义的分层集合（类似文件夹），用于把常用工具按分析需求组织在一起；不涉及工具间的数据传递与顺序执行。实现需一次性到位，避免半成品。

## 1. 目标与非目标

- 目标
  - 提供“工作流”视图，允许用户新建命名的集合，将工具加入集合中，形成层级化的个人工具包。
  - 同一工具可在同一工作流中出现多次（允许重复项）。
  - 支持“编辑排序”模式：卡片上/下移动或拖拽重排，保存顺序。
  - 添加工具时复用“全部工具”页的卡片/搜索体验；卡片主按钮文案变为“添加”。
  - 添加确认弹窗，带“今日不再提示”勾选（当天后续添加不再弹）。
  - 与现有工具安装/启动/计时逻辑解耦，不影响现有功能。

- 非目标（未来版本考虑）
  - 工具间自动数据传递、参数编排、链式执行。
  - 并行/条件/循环等编排语义。
  - 颜色/图标标识、模板市场、共享与权限等高级特性。

## 2. 信息架构与入口

- 侧边栏新增导航项：🧩 工作流（`view_name = "workflows"`）。
  - 插入位置：位于“我的工具（my-tools）”与“设置（settings）”之间。
  - 文件：`ui/modern_sidebar.py` 的 `nav_items` 列表新增一项。

- 视图结构
  - 工作流列表页（WorkflowsMainView）
  - 工作流详情页（WorkflowsDetailView）
  - 选择工具页（ToolPickerDialog 或全屏选择页），复用“全部工具”卡片与搜索，仅更换按钮文案/行为。

## 3. 数据模型与持久化

- 新文件：`config_data/workflows.json`

```json
{
  "version": 1,
  "workflows": [
    {
      "id": "uuid-v4",
      "name": "RNA-Seq 基础分析",
      "description": "常用工具集合",
      "tools": [
        { "tool_name": "FastQC", "note": "读段质控" },
        { "tool_name": "BWA" },
        { "tool_name": "SAMtools", "note": "排序/索引" },
        { "tool_name": "FastQC" } // 允许重复
      ],
      "created_at": "2025-10-28T10:00:00",
      "updated_at": "2025-10-28T10:30:00"
    }
  ]
}
```

- 偏好设置：`config_data/workflows_prefs.json`

```json
{
  "suppress_add_confirm_until": "2025-10-28"  // 当天不再提示“添加确认”
}
```

- 工具来源仍以 `config_data/tools.json` 为准，工作流只存工具名引用，不复制工具信息。

## 4. 交互与 UI 细节

### 4.1 工作流列表页（WorkflowsMainView）
- 布局：复用工具卡片网格布局风格。
- 卡片类型：
  - 新建卡片（首卡，居中大“＋”图标）：点击 → 弹出“新建工作流”对话框（名称必填，描述可选）。
  - 普通工作流卡片：展示名称、工具数量、最后更新时间；点击进入详情；右上角菜单：重命名 / 复制 / 删除。

### 4.2 工作流详情页（WorkflowsDetailView）
- 顶部栏：左上“返回 <”+ 当前工作流名（沿用工具详情页返回样式与动画）。
- 主区：网格卡片
  - 新建卡片（首卡）：“添加工具”。
  - 工具条目卡片：复用工具卡片视觉（名称、描述、状态点），但底部按钮改为“移除”。
- 编辑排序模式（方案B）
  - 入口：右上“编辑排序”开关。
  - 行为：每个条目出现“上移/下移”按钮；可选支持拖拽，任一方式实现即可；保存后更新 `tools` 顺序与 `updated_at`。

### 4.3 选择工具页（ToolPicker）
- 体验：复用“全部工具”的卡片网格与搜索过滤。
- 按钮：
  - 卡片底部按钮文案改为“添加”。
  - 进入详情时，详情页主按钮也改为“添加”。
- 添加确认：点击“添加”→ 弹出确认对话框（确认/取消 + 勾选项“今日不再提示”）。若当天已勾选，则不再弹出，直接添加。
- 添加完成：返回工作流详情页，光标滚动到新条目，闪烁/高亮 1–2 秒作为反馈。

## 5. 行为定义

- 新建工作流
  - 校验名称唯一；若重名，提示并建议自动追加“(2)”等后缀。
  - 创建后落盘 `workflows.json`，并刷新列表页。

- 添加工具
  - 允许重复添加同一工具；按添加时间顺序出现在列表末尾（可在“编辑排序”中调整）。
  - 不检查工具是否安装；卡片状态点仍按真实安装状态显示。

- 移除工具
  - 仅移除当前工作流中的该条目；不影响工具本体。

- 排序
  - “编辑排序”开启后才可移动；保存时写回 `workflows.json`。

- 删除工作流
  - 确认对话框；删除仅移除工作流，不影响工具与其他数据。

## 6. 集成与模块

- 侧边栏：`ui/modern_sidebar.py` 增加 `workflows` 导航项与高亮逻辑。
- 主窗体：`ui/main_window.py`
  - 新增：
    - `WorkflowsMainView`（列表页）
    - `WorkflowsDetailView`（详情页）
    - `ToolPickerDialog` 或全屏 `ToolPickerPage`
  - 处理视图切换与返回；从 `ConfigManager` 初始化/保存工作流数据。

- 工具卡片复用：`ui/tool_card_v3.py`
  - 为选择器提供“添加模式”（按钮文案/信号改为 `add_requested(tool_name)`），不影响默认“启动/安装/详情”模式。
  - 或保留原卡片，额外做一层包装在选择器里覆盖按钮行为。

- 工作流数据管理：`utils/workflows_manager.py`
  - load/save、创建/重命名/删除工作流、添加/移除/排序工具、偏好管理（不再弹出）。

## 7. i18n

新增（中/英）翻译键：
- "Workflows"、"New Workflow"、"Create"、"Rename"、"Duplicate"、"Delete"
- "Add Tool"、"Add"、"Remove"、"Edit Order"、"Done"
- "Are you sure to add {0}?"、"Do not ask again today"

## 8. 非功能性要求

- 一次性落地实现，避免占位/死代码。
- 不影响现有安装、启动、计时逻辑与日志体系。
- 配置文件写失败需有错误提示与降级处理（内存态不丢）。
- 日志：通过 `utils/unified_logger` 记录工作流的创建、添加、移除、排序等操作。

## 9. 回退与兼容

- 不改动现有收藏逻辑；“工作流”与“收藏”并行存在、互不影响。
- 若 `workflows.json` 缺失则按空集合初始化；损坏时尝试备份并重建。

---

实现备注：待你确认本设计后，我将一次性在 `BioNexus_1.3.4` 中完成全部代码与界面改动（包含导航、3个视图、数据持久化、选择器“添加模式”、排序编辑、确认弹窗偏好），确保无空壳代码与不完整路径。

